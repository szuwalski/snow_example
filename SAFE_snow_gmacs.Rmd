---
author: "Cody Szuwalski"
date: "September 13, 2023"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 6
header-includes:   
-  \pagenumbering{gobble}
number_sections: yes
csl: fish-and-fisheries.csl
toc: yes
title: "An assessment for eastern Bering Sea snow crab"
---

```{r, include=FALSE}

rm(list=ls())

knitr::opts_chunk$set(echo=FALSE,message=FALSE,warning=FALSE)

library(plyr)
library(dplyr)
library(knitr)
library(ggplot2)
library(PBSmodelling)
library(pander)
library(coda)
library(maps)
library(lattice)
library(PBSmapping)
library(mapdata)    #some additional hires data
library(maptools)   #useful tools such as reading shapefiles
library(mapproj)
library(plotrix)
library(ggridges)
library(reshape2)
library(miceadds)
library(devtools)
library(patchwork)

library(devtools)
devtools::install_github("GMACS-project/gmr")
library(gmr)


```

\newpage

```{r,echo=F,message=FALSE,warning=F,include=FALSE}

ABC_buffer  <-0.8
chosen_ind<-1
OFL_fleet_ind<-0

# #===PULL gmacs DATA AND outputs
mod_names <- c(
  "Simple")
ScenarioNames<-mod_names

# needs terminal backslash
.MODELDIR = c(paste0(dirname(getwd()), "/snow_example/simple/"))


.THEME    = theme_bw(base_size = 12, base_family = "") +
  theme(strip.text.x = element_text(margin= margin(1,0,1,0)),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        strip.background = element_rect(color="white",fill="white"))

.OVERLAY  = TRUE

#==some of this repeats info in the .DAT file and should be read directly, rather than
#==repeated here (e.g. .FLEET and .SEAS)
.SEX      = c("Male")
.FLEET    = c("Pot_Fishery","NMFS_Trawl_1989")
.All_FLEET    = c("Pot_Fishery","NMFS_Trawl_1989")
.TYPE     = c("Retained","Discarded","Total")
.SHELL    = c("New","Old")
.MATURITY = c("Aggregate","Mature","Immature")
.SEAS     = c("1","2","3")

fn       <- paste0(.MODELDIR, "gmacs")
M        <- lapply(fn, read_admb) #need .prj file to run gmacs and need .rep file here
names(M) <- mod_names

# fn       <- paste0(.MODELDIR2, "gmacs")
# Q        <- lapply(fn, read_admb) #need .prj file to run gmacs and need .rep file here
# names(Q) <- mod_names
# 
# use_mod_man<-Q
#==loop through the size comp data, plot and save to be included later
#==this takes a longish time, so do it once to speed up knitting
#  mdf <- .get_sizeComps_df(M)
#      ix <- pretty(1:length(M[[1]]$mid_points))
#  for(x in 1:13)
#  {
#  png(paste("plots/size_comp_",x,".png",sep=""),height=10,width=8,res=300,units='in')
#  p<-ggplot(mdf[[x]])+
#    geom_bar(aes(variable, value), stat = "identity", position = "dodge", alpha = 0.5, fill = "grey")+
#    geom_line(aes(as.numeric(variable), pred, col = model), alpha = 0.85)+
#    facet_wrap(~year,dir="v")+theme_bw()+
#    theme(axis.text.x = element_text(angle = 45, vjust = 0.5, size = 6),
#                        strip.text.x = element_text(margin= margin(1,0,1,0)),
#                        panel.grid.major = element_blank(),
#                        panel.grid.minor = element_blank(),
#                        legend.position='bottom',
#                        panel.border = element_blank(),
#                        strip.background = element_rect(color="white",fill="white"),
#          legend.text=element_text(size=7))+
#    scale_x_discrete(breaks=M[[1]]$mid_points[ix])+
#    xlab("Carapace width (mm)")+ylab("Proportion")
#  print(p)
#  dev.off()
# }

 # dfdf <- .get_sizeComps_df(M[c(1,2,3)])
 # ix <- pretty(1:length(M[[1]]$mid_points))
 # all_df<-NULL
 # for(x in 14:21)
 #   all_df<-rbind(all_df,dfdf[[x]])
 # 
 # png(paste("plots/bsfrf_size_comps.png",sep=""),height=10,width=8,res=300,units='in')
 # p<-ggplot(all_df)+
 #   geom_bar(aes(variable, value), stat = "identity", position = "dodge", alpha = 0.5, fill = "grey")+
 #   geom_line(aes(as.numeric(variable), pred, col = model), alpha = 0.85)+
 #   facet_wrap(~year+fleet+sex,dir="v")+theme_bw()+
 #   theme(axis.text.x = element_text(angle = 45, vjust = 0.5, size = 6),
 #                       strip.text.x = element_text(margin= margin(1,0,1,0)),
 #                       panel.grid.major = element_blank(),
 #                       panel.grid.minor = element_blank(),
 #                       legend.position='bottom',
 #                       panel.border = element_blank(),
 #                       strip.background = element_rect(color="white",fill="white"),
 #         legend.text=element_text(size=7))+
 #   scale_x_discrete(breaks=M[[1]]$mid_points[ix])+
 #   xlab("Carapace width (mm)")+ylab("Proportion")
 # print(p)
 # dev.off()
 # 
 
 #=================================
 # this code pulls the projections for selected models
 # to do the projections, follow these steps:
 # this requires a converged model with a hessian
 # make a new folder with the model to project in it, specify projection details in .PROJ file
 # .PROJ file needs to change strategies
 # run '.\gmacs.exe -phase 6 -nohess -mcmc 1 -mcsave 1'
 # that executes one draw (at the MLE) of MCMC and saves the results
 # run '.\gmacs.exe -mceval -noest' in that folder to write output to 'mcoutPROJ.REP'
 # run code below to pull relevant info, be sure to modify years to make 'mcoutPROJ.REP'
#  proj_dirs<-c(paste(.MODELDIR[chosen_ind],"proj/mcoutPROJ.REP",sep=''),
#               paste(.MODELDIR2[chosen_ind],"proj/mcoutPROJ.REP",sep=''))
# 
#  proj_mmb_under_ofl<-rep(NA,length(proj_dirs))
#  proj_stat_ofl<-rep(NA,length(proj_dirs))
#  proj_mmb_under_nof<-rep(NA,length(proj_dirs))
#  proj_stat_nof<-rep(NA,length(proj_dirs))
# 
#  for(x in 1:length(proj_dirs))
#  {
#   innames<-c("Draw","Replicate","Treatment",paste("F",seq(1,4)),
#              "B35",seq(2023,2025))
#   projfile<-as.data.frame(matrix(scan(proj_dirs[x],skip=1),ncol=length(innames),byrow=TRUE))
#   colnames(projfile)<-innames
# 
#   proj_mmb_under_ofl[x]<-filter(projfile,Treatment==2)$'2023'[1]
#   proj_stat_ofl[x]<-proj_mmb_under_ofl[x]/filter(projfile,Treatment==2)$'B35'[1]
# 
#   proj_mmb_under_nof[x]<-filter(projfile,Treatment==1)$'2023'[1]
#   proj_stat_nof[x]<- proj_mmb_under_nof[x]/filter(projfile,Treatment==2)$'B35'[1]
# }


```

\newpage




```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8.5,fig.height=8,fig.cap="\\label{mmbfits}Model fits to the observed mature biomass at survey."}

    mdf <- .get_cpue_df(M)
    mdf<-filter(mdf,fleet=="NMFS_Trawl_1982"|fleet=="NMFS_Trawl_1989")

ggplot(data=mdf)+
  geom_pointrange(aes(year, cpue, ymax = ube, ymin = lbe) )+
  geom_line(aes(x=year,y=pred,col=Model,group=Model),lwd=2,alpha=0.8)+
  theme_bw()+facet_wrap(~sex,ncol=1,scales='free_y')+
  theme(legend.position=c(.8,.35))+ylab("Biomass (1,000 t)")




```

\newpage

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=6,fig.cap="\\label{growthfits}Model fits (colored lines) to the growth data (black dots)."}
   mdf <- .get_gi_df(M)
    obs_in<-dplyr::filter(mdf,type=="obs")
    pred_in<-dplyr::filter(mdf,type=="pred")
  pred_in$Sex<-recode_factor(pred_in$Sex,'1'="Male",'2'="Female")
  obs_in$Sex<-recode_factor(obs_in$Sex,'1'="Male",'2'="Female")
    p <- ggplot(obs_in) +
        expand_limits(y=0) +
        facet_wrap(~Sex,scales='free_x') +
        geom_line(data=pred_in,aes(x=Premolt,y=molt_inc,col=Model),lwd=1.5,alpha=.8) +
        .THEME+ geom_point(aes(x=Premolt,y=molt_inc))+
      ylab("Molt increment (mm)")+
      xlab("Pre-molt carapace width (mm)")+
      theme(legend.position=c(.2,.8))
print(p)

```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=7,fig.height=8,fig.cap="\\label{size_trans}Size transition matrix from the author-preferred model."}

t_mat<-M[[chosen_ind]]$growth_matrix_1_1
colnames(t_mat)<-M[[chosen_ind]]$mid_points
rownames(t_mat)<-M[[chosen_ind]]$mid_points
indat<-(melt(t_mat))
indat1<-data.frame("Premolt"=as.numeric(indat$Var1),
                   "Postmolt"=as.numeric((indat$Var2)),
                   "Increment"=as.numeric(indat$value))

p <- ggplot(dat=indat1) 
p <- p + geom_density_ridges(aes(x=Premolt, y=Postmolt, height = Increment,
                                 group = Postmolt, 
                                 fill=stat(y),alpha=.9999),stat = "identity") +
  scale_fill_viridis_c()+
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90)) +
  labs(x="Post-molt carapace width (mm)",y="Pre-molt carapace width (mm)") +
  xlim(25,135)
print(p)

```


\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.width=8,fig.height=8,fig.cap="\\label{catchfits}Model fits to catch data."}

   mdf <- .get_catch_df(M)
   mdf$type<-as.character(mdf$type)
   mdf$type[which(mdf$type=="Discarded")]<-"Retained"
   mdf$type[which(mdf$type=="Total")]<-"Discarded"
  p <- ggplot(mdf, aes(x = year, y = observed)) +
        geom_bar(stat = "identity", position = "dodge", alpha = 0.15,col='light grey') +
        geom_linerange(aes(x = year, y = observed, ymax = ub, ymin = lb, position = "dodge"), size = 0.2, alpha = 0.5, col = "black") 
  p <- p + geom_line(aes(x = as.integer(year), y = predicted,col=model), lwd=1.5,alpha=.8) +
                facet_wrap(~fleet + sex + type + units, scales = 'free_y')+.THEME+
    theme(legend.position=c(.85,.3))+ylab("Biomass (1,000 t)")

print(p)

```



\newpage



```{r,echo=FALSE,warning=FALSE,message=F,out.width="100%",fig.cap="\\label{size_comp_1}Model fits (lines) to the retained catch size composition data (grey bars)."}

include_graphics("plots/size_comp_1.png")


```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,out.width="100%",fig.cap="\\label{size_comp_2}Model fits (lines) to the total catch size composition data (grey bars)."}

include_graphics("plots/size_comp_2.png")


```

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,out.width="100%",fig.cap="\\label{size_comp_3}Model fits (lines) to the female discard size composition data (grey bars)."}

include_graphics("plots/size_comp_3.png")

```


```{r,echo=FALSE,warning=FALSE,message=F,fig.height=8,fig.width=8,fig.cap="\\label{predmmb}Model predicted mature biomass at mating time in 1,000 tonnes. "}
#=========================================================
#  Plot derived quantities
#=========================================================

ssb_df<-NULL
for(i in 1:length(M))
{
  indf<-data.frame(SSB=M[[i]]$ssb,
                   Year=M[[i]]$mod_yrs,
                   model=mod_names[i],
                   MSST=M[[i]]$spr_bmsy/2,
                   BMSY=M[[i]]$spr_bmsy)
  ssb_df<-rbind(ssb_df,indf)
}

allup<-ggplot(ssb_df)+
  geom_line(aes(x=Year,y=SSB,col=model),lwd=1.5)+
  theme_bw()+theme(legend.position=c(.8,.8))+
  geom_line(aes(x=Year,y=MSST,col=model),lty=2)

print(allup)
#==plot models that converged?
# ggplot(ssb_df)+
#   geom_histogram(aes(x=status,fill=model))+
#   theme_bw()+theme(legend.position=c(.8,.8))+
#   geom_vline(xintercept=0.5)+
#   facet_wrap(~model)

# names(M[[1]])
# plot(M[[1]]$obs_catch_out[1,]+filter(ssb_df,model=="100mm")$SSB,type='b')
# M[[1]]$obs_catch_out[1,]/(M[[1]]$obs_catch_out[1,]+filter(ssb_df,model=="100mm")$SSB)
```


\newpage




\newpage


```{r,echo=FALSE,warning=FALSE,message=F,fig.height=8,fig.width=8,fig.cap="\\label{predselect}Estimated selectivities."}

 # fix for catchability
  mdf <- .get_selectivity_df(M)
  mdf <- mdf[!mdf$sex%in%"Aggregate",]
  ncol <-length(unique(mdf$fleet))
  nrow <-length(unique(mdf$Model))
  nrow_sex <-length(unique(mdf$sex))

 
  
    p <- ggplot(mdf) + expand_limits(y = c(0,1))+
      geom_line(aes(x=variable,y=value,col=Model,linetype=type),lwd=1.5,alpha=.8)+
      facet_wrap(~fleet+sex)+theme_bw()+theme(legend.position='bottom')
 
     print(p)
  
  


```

\newpage


```{r,echo=FALSE,warning=FALSE,message=F,fig.height=10,fig.width=8,fig.cap="\\label{predfmort}Estimated fishing mortalities for the directed and non-directed fisheries."}

    n <- length(M)
    fdf <- NULL
    fbar <- NULL
    for ( i in 1:n )
    {
        A <- M[[i]]
        nyear <- length(A$mod_yrs)
        nseas <- nseason <- A$nseason
        nclass <- length(A$mid_points)
        nfleet <- A$nfleet
        df <- data.frame(A$ft, Model = names(M)[i])
        colnames(df) <- c(1:nseason, "model")
        df$year <- rep(A$mod_yrs, by = nfleet)
        # df$fleet <- rep(.FLEET, each = nyear*A$nsex)
        if(i>1)df$fleet <- rep(.All_FLEET[1:4], each = nyear*A$nsex)
        if(i==1)df$fleet <- rep(.All_FLEET, each = nyear*A$nsex)
        df$sex <- rep("Sex",nrow(df))
        if(A$nsex==2)
          df$sex <- rep(rep(c("Male","Female"),each = nyear),nfleet)
        del <- NULL
        for ( j in 1:nseason )
        {
            if (all(df[,j] == 0))
            {
                del <- c(del, j)
                nseas <- nseas - 1
            }
        }
        df <- df[,-del]
        df <- tidyr::gather(df, "season", "F", 1:nseas)
        for ( j in unique(df$model) )
        {
            for ( k in unique(df$season) )
            {
                for ( l in unique(df$fleet) )
                {
                    if (all(df[df$model %in% j & df$season %in% k & df$fleet %in% l,]$F == 0)) df <- df[-which(df$model %in% j & df$season %in% k & df$fleet %in% l),]
                }
            }
        }
        fdf <- rbind(fdf, df)

        df <- data.frame(Model = names(M)[i], fbar = exp(A$log_fbar))
        if(i>1)df$fleet <- .FLEET[1:4]
        if(i==1)df$fleet <- .All_FLEET
        df <- df[which(df$fleet %in% unique(fdf$fleet)),]
        fbar <- rbind(fbar, df)
    }
    fdf$year <- as.integer(fdf$year)
   

ggplot(data = fdf) + 
   geom_line(aes(x=year, y=F,col=model,group=model),lwd=1.5,alpha=.8)+ 
   theme_bw()+
   theme(legend.position=c(.2,.8))

```



\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.height=10,fig.width=8,fig.cap="\\label{predmat}Estimated (black line) or specified (colored lines) probability(s) of maturing for male crab."}

   mdf <- .get_molt_prob_df(M)
   p <- ggplot() +
        expand_limits(y = c(0, 1)) +
        labs(x = "Carapace width (mm)", y ="Probability of terminal molt")+ 
     geom_line(data=mdf, aes(x = Length, y = MP,linetype = Model, col = Year),lwd=1.5,alpha=.8) + 
     theme_bw()+theme(legend.position='bottom')


    print(p)
```

\newpage
\newpage
\clearpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.height=10,fig.width=8,fig.cap="\\label{recruits}Estimated recruitment by sex (bottom) and proportions recruiting to length bin (top) by model."}

    n <- length(M)
    mdf <- NULL
    for(i in 1:n)
    {
        A  <- M[[i]]
        df <- data.frame(Model = names(M)[i],
                         mid_points = A$mid_points,
                         rec_sdd = as.vector(t(A$rec_sdd)),
                         sex =  rep(1:A$nsex, each = length(A$mid_points)))

        mdf <- rbind(mdf, df)
    }

r_s<-ggplot(mdf)+
  geom_line(aes(x=mid_points,y=rec_sdd,col=Model),lwd=1.5,alpha=0.6)+
    geom_point(aes(x=mid_points,y=rec_sdd,col=Model),size=2.5)+
  theme_bw()+facet_wrap(~sex,ncol=2,scales='free_y')+
  ylab("Proportion recruiting")+xlab("Carapace width (mm)")
    
    
recs_df<-NULL
for(i in 1:length(M))
{
  indf<-data.frame(Recruits=c(M[[i]]$recruits),
                   sex=c(rep("Male",length(M[[i]]$recruits))),
                   Year=c(M[[i]]$mod_yrs),
                   model=mod_names[i])
  recs_df<-rbind(recs_df,indf)
}

r_g<-ggplot(recs_df)+
  geom_line(aes(x=Year,y=Recruits,col=model),lwd=1.5)+
  theme_bw()+facet_wrap(~sex,ncol=1,scales='free_y')
 
(r_s/r_g)+plot_layout(heights=c(1,5))

``` 

\newpage

```{r,echo=FALSE,warning=FALSE,message=F,fig.height=10,fig.width=8,fig.cap="\\label{nat_m}Estimated natural mortality by sex and maturity state. Natural mortality in all years previous to 2018 and after 2019 are equal to the estimated M in 2017. "}

    mdf <- .get_M_df(M)
    ggplot(mdf, aes(x = Year, y = M, colour = Model))+
      geom_line(lwd=1.5,alpha=.8)+
     facet_wrap(~Sex+maturity)+
     theme_bw()+theme(legend.position=c(.1,.3))+
      xlim(2015,2022)+expand_limits(y=0)
   


```
 
\newpage




